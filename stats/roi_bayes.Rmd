---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.11.1
  kernelspec:
    display_name: R
    language: R
    name: ir
output: 
  html_document:
    theme: spacelab
title: ROI analysis
---

This analysis takes the parameter estimates extracted from first level con files with `spm_summarise` and compares them between groups (friend vs stranger).

The following regions have been selected:

- Anterior insula (AI)
- Anterior mid-cingulate cortex (aMCC)
- Amygdala
- Fusiform face Area (FFA)
- Right posterior Superior Temporal Sulcus (rpSTS)
- Right temporo-parietal junction (rTPJ).

All ROIs were based on Neurovault collection [Computing the Social Brain Connectome Across Systems and States](https://neurovault.org/collections/2462/) and a corresponding [article](https://academic.oup.com/cercor/article/28/7/2207/3831104) with the same title. The AI, amygdala and FFA ROIs from both hemispheres were merged (ie. parameters estimates were averaged over voxels from left and right hemisphere), while lateralised definitions were used for rpSTS and rTPJ, and there was only one, non-lateralised, aMCC seed in the collection.

For each region, groups (friend vs stranger) are compared using `t.test` from built-in `stats` and `ttestBF` from `BayesFactor`.

```{r, message=FALSE}
library('tidyverse')
library('BayesFactor')
library('ggpubr')
library('ini')
```

## Data import

Required data are generated by `spm/complete/roi/extract_from_roi.m`.
There are two files for OFL, the primary one based on US > noUS contrast, and the other based on US stick contrast.
The file for DE is baserd on the CS+ > CS- contrast.

```{r}
config <- read.ini("../config.ini")
data_dir <- file.path(config$SPM$ROOT, "complete", "other")

ofl <- read_csv(file.path(data_dir, "roi_stats_ofl.csv"), col_types = cols())
de <- read_csv(file.path(data_dir, "roi_stats_de.csv"), col_types = cols())
ofl_us <- read_csv(file.path(data_dir, "roi_stats_ofl-us.csv"), col_types = cols())
ofl_no_us <- read_csv(file.path(data_dir, "roi_stats_ofl-nous.csv"), col_types = cols())
```

If the figures directory does not exist, create it here:
```{r}
if(!dir.exists("figures")) {
    dir.create("figures")
}
```

Set the target ppi for saving
```{r}
target_ppi = 300
```

## OFL - figure

Contrast estimates & 95 % confidence intervals for the observational UR (obs US - obs noUS).

```{r}
ofl_plot <- ofl %>%
    mutate(group = as.factor(group)) %>%
    rename(Amy = amygdala) %>%
    pivot_longer(cols = where(is.numeric), names_to = "roi", values_to = "contrast estimate") %>%
    ggbarplot(x = "group", y = "contrast estimate", facet.by = "roi", add = "mean_ci",
              color = "group", palette = c("#E66100", "#5D3A9B"),
              xlab = FALSE, legend.title = "") +
    rremove("x.text") + rremove("x.ticks")

ofl_plot
```

Save the plot, making it compact (2 x 3.5 in).
This way, it can be combined with the brain plots (double row, 6 x 3.5 in).

```{r}
ggexport(
    ofl_plot,
    filename = "figures/roi_ofl.png",
    width = 2 * target_ppi,
    height = 3.5 * target_ppi,
    res = target_ppi,
    pointsize = 8
)
```

## DE - figure

Contrast estimates & 95 % confidence intervals for the direct CR (CS+ - CS-).
Arranged in one row.

```{r}
de_plot <- de %>%
    mutate(group = as.factor(group)) %>%
    rename(Amy = amygdala) %>%
    pivot_longer(cols = where(is.numeric), names_to = "roi", values_to = "contrast estimate") %>%
    ggbarplot(x = "group", y = "contrast estimate", facet.by = "roi", add = "mean_ci",
              color = "group", palette = c("#E66100", "#5D3A9B"),
              xlab = FALSE, ylab = "contr. est.", nrow = 1, legend = "top") +
    rremove("x.text") + rremove("x.ticks")

de_plot
```

Save the plot, making it compact (4 x 1.75 in).
This way, it can be combined with the brain plots (single row, 6 x 1.75 in).

```{r}
ggexport(
    de_plot,
    filename = "figures/roi_de.png",
    width = 4 * target_ppi,
    height = 1.75 * target_ppi,
    res = target_ppi,
    pointsize = 8
    )
```

## OFL (US and noUS) - figure

Might be good to show contrast estimates separately for US and noUS.
There is one data file per contrast, so we need to join them first:

```{r}
ofl_both <- left_join(ofl_us, ofl_no_us, by = c("label", "group"), suffix = c(".us", ".nous"))
```

For the plot, we will pivot longer and identify an observation by 2 columns (roi, contrast).
This way we can put contrast on x axis.

```{r}
ofl_both_plot <- ofl_both %>%
    mutate(group = as.factor(group)) %>%
    pivot_longer(cols = where(is.numeric), names_to = c("roi", "contrast"), names_sep = "[^[:alnum:]]",
                 values_to = "contrast estimate") %>%
    mutate(contrast = str_replace_all(contrast, c("no" = "no ", "us" = "US"))) %>%
    ggbarplot(x = "contrast", y = "contrast estimate", facet.by = "roi", add = "mean_ci",
              color = "group", palette = c("#E66100", "#5D3A9B"),
              position = position_dodge(0.9),
              xlab = FALSE, legend.title = "")

ofl_both_plot
```

```{r}
ggexport(
    ofl_both_plot,
    filename = "figures/roi_ofl-sticks.png",
    width = 4 * target_ppi,
    height = 3.5 * target_ppi,
    res = target_ppi,
    pointsize = 8
)
```

For an alternative take, we will order the bars: friend us, friend no us, stranger us, stranger no us.
We will distinguish them by color (transparency).

```{r}
ofl_bonus_plot <- ofl_both %>%
    pivot_longer(cols = where(is.numeric), names_to = c("roi", "contrast"), names_sep = "[^[:alnum:]]+",
                 values_to = "contrast estimate") %>%
    mutate(
        contrast = str_replace_all(contrast, c("no" = "no ", "us" = "US")),
        thing = str_c(group, " ", contrast)
    ) %>%
    ggbarplot(x = "thing", y = "contrast estimate", facet.by = "roi", add = "mean_ci",
              order = c("friend US", "friend no US", "stranger US", "stranger no US"),
              color = "thing", palette = c("#E66100", "#E6610088", "#5D3A9B", "#5D3A9B88"),
              xlab = FALSE, legend.title = "") +
    rremove("x.text") + rremove("x.ticks")

ofl_bonus_plot
```

```{r}
ggexport(
    ofl_bonus_plot,
    filename = "figures/roi_ofl-sticks_alt.png",
    width = 5 * target_ppi,  # bit wider to fit all legends
    height = 3.5 * target_ppi,
    res = target_ppi,
    pointsize = 8
)
```


## OFL - stats

Below is a rundown of all t-tests (classical and bayesian).

### OFL AI

```{r}
frm = AI ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

### OFL aMCC

```{r}
frm = aMCC ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

### OFL amygdala

```{r}
frm = amygdala ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

### OFL FFA

```{r}
frm = FFA ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

### OFL rpSTS

```{r}
frm = rpSTS ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

### OFL rTPJ

```{r}
frm = rTPJ ~ group
t.test(frm, ofl)
1 / ttestBF(formula = frm , data = ofl)
```

## DE - stats


### DE AI

```{r}
frm = AI ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

### DE aMCC

```{r}
frm = aMCC ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

### DE amygdala

```{r}
frm = amygdala ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

### DE FFA

```{r}
frm = FFA ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

### DE rpSTS

```{r}
frm = rpSTS ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

### DE rTPJ

```{r}
frm = rTPJ ~ group
t.test(frm, de)
1 / ttestBF(formula = frm , data = de)
```

## OFL US stats


### OFL AI (US)

```{r}
frm = AI ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```

### OFL aMCC (US)

```{r}
frm = aMCC ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```

### OFL amygdala (US)

```{r}
frm = amygdala ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```

### OFL FFA (US)

```{r}
frm = FFA ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```

### OFL rpSTS (US)

```{r}
frm = rpSTS ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```

### OFL rTPJ (US)

```{r}
frm = rTPJ ~ group
t.test(frm, ofl_us)
1 / ttestBF(formula = frm , data = ofl_us)
```
